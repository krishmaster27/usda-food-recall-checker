<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Saved Products</title>
  <link rel="stylesheet" href="sidebar.css">
  <link rel="stylesheet" href="saved-products.css">
</head>
<body>

<div class="sidebar">
    <h2>Menu</h2>
    <a href="index.html">Home</a>
    <a href="sign-up.html">Sign Up</a>
    <a href="sign-in.html">Sign In</a>
    <a href="user-profile.html">Profile</a>
    <a href="saved-products.html" class="active">Saved Products</a>
    <a href="expiration-reminders.html">Expiration Reminders</a>
</div>

<div class="main-content">
  <h1>Saved Products</h1>

  <ul id="productList">
    <p id="loadingMsg">Loading your saved products...</p>
  </ul>
</div>

<script>
window.addEventListener("DOMContentLoaded", async () => {
  // --- Redirect if not logged in ---
  const user = JSON.parse(localStorage.getItem("loggedInUser"));
  if (!user) {
    alert("Please sign in to view saved products.");
    window.location.href = "sign-in.html";
    return;
  }

  const listEl = document.getElementById("productList");

  // --- Load Products from Server ---
  async function loadProducts() {
    try {
      const response = await fetch(`/get-user-products?phone=${user.phone}`);
      const data = await response.json();
      
      listEl.innerHTML = ""; // This clears the "Loading..." message safely

      if (!data.products || data.products.length === 0) {
        listEl.innerHTML = "<p style='text-align:center;'>No saved products found. Scan items from the Home page to see them here!</p>";
        return;
      }

      data.products.forEach(p => {
        const li = document.createElement("li");
        li.style.listStyle = "none";
        li.innerHTML = `
          <div class="product-row">
            <span>${p.product}</span>
            <div class="buttons">
              <button class="show-btn" onclick="toggleRecalls(this)">Show Recalls</button>
              <button class="delete-btn" onclick="deleteProduct(this, '${p.product}')">Delete</button>
            </div>
          </div>
          <div class="recalls" style="display:none;">
            <p>Searching USDA database...</p>
          </div>
        `;
        listEl.appendChild(li);
      });
    } catch (err) {
      console.error(err);
      listEl.innerHTML = "<p>Error loading products from server.</p>";
    }
  }

  // --- Toggle Recalls ---
  window.toggleRecalls = async function(button) {
    const li = button.closest("li");
    const productName = li.querySelector("span").textContent;
    const recallsDiv = li.querySelector(".recalls");

    if (recallsDiv.style.display === "block") {
      recallsDiv.style.display = "none";
      button.textContent = "Show Recalls";
    } else {
      recallsDiv.style.display = "block";
      button.textContent = "Hide Recalls";

      const recRes = await fetch(`/check-recalls?food=${encodeURIComponent(productName)}`);
      const recData = await recRes.json();
      
      if (recData.recalls && recData.recalls.length > 0) {
        recallsDiv.innerHTML = "<ul>" + recData.recalls.map(r => `
          <li style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">
            <strong>DATE:</strong> ${r.field_recall_date}<br>
            <strong>TITLE:</strong> ${r.field_title}<br>
            <strong>REASON:</strong> ${r.field_recall_reason || "Listeria/Salmonella risk - see USDA summary"}
          </li>
        `).join("") + "</ul>";
      } else {
        recallsDiv.innerHTML = "<p>âœ… No active recalls found for this item.</p>";
      }
    }
  }

  // --- Delete Product ---
  window.deleteProduct = async function(button, productName) {
    if (confirm(`Delete ${productName}?`)) {
      const res = await fetch('/delete-product', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ phone: user.phone, product: productName })
      });
      if (res.ok) {
        button.closest("li").remove();
        // If the last item was deleted, show the "No products" message
        if (listEl.children.length === 0) {
            listEl.innerHTML = "<p style='text-align:center;'>No saved products found.</p>";
        }
      }
    }
  }

  loadProducts();

  // --- Sidebar Logic ---
  const sidebar = document.querySelector('.sidebar');
  const content = document.querySelector('.main-content');
  setTimeout(() => {
    sidebar.classList.add('active');
    content.classList.add('shifted');
  }, 100);

  const toggleBtn = document.createElement('button');
  toggleBtn.innerHTML = '&#9776;';
  toggleBtn.style.cssText = "position:fixed; top:7px; left:-9px; font-size:24px; background:#0074D9; color:white; border:none; border-radius:6px; padding:10px 14px; cursor:pointer; z-index:1100;";
  document.body.appendChild(toggleBtn);

  toggleBtn.addEventListener('click', () => {
    sidebar.classList.toggle('active');
    content.classList.toggle('shifted');
  });
});
</script>

</body>
</html>
